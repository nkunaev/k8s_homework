# Домашнее задание к занятию «Компоненты Kubernetes»

### Задание. Необходимо определить требуемые ресурсы
Известно, что проекту нужны база данных, система кеширования, а само приложение состоит из бекенда и фронтенда. Опишите, какие ресурсы нужны, если известно:

1. Необходимо упаковать приложение в чарт для деплоя в разные окружения. 
2. База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
3. Кеш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
4. Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий. 
5. Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.


Итак, сначала учтем накладные расходы, по своей практике это примерно 10% от общего объема ресурсов. Обычно этого запаса хватает на разного рода core_dump, self оптимизации BD, работу garbage collector-ов и чтоб ООМ не нервничал.

В идеале было бы получить информацию о динамике нагрузки на сервис, данные по нагрузочному тестированию (для установления лимитов), потребности в автоскейлинге, но учитывая, что сведений нет, возьмем за данность, что нагрузка сервис статична, запрошенные данные являются requests, а деплой происходит canary методом, т.е. с постепенного замещения старых версий - новыми, а не Blue/Green.

Также возьмем за данность, что у нас 3 основных окружения: dev, stage, prod.

Общую мощность серверов, с учетом запаса в можности на отказ 1 ноды будем рассчитывать по формуле N+1.

Теперь посчитаем требования с сервисам с учетом накладных расхоов:

БД -  Потребляет ГБ ОЗУ в работе, 1 ядро, с учетом накладных получится 4506МБ (4096+410) и 1.1 CPU * 3 копии = 13,2Gb RAM 3.3 CPU

Кэш - Потребляет ГБ ОЗУ в работе, 1 ядро, с учетом накладных получится 4506МБ (4096+410) и 1.1 CPU * 3 копии = 13,2Gb RAM 3.3 CPU

Фронт - 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра, с учетом накладных расхонов 55МБ, ядрами можно пренебречь * 5 копий = 275МБ + 1CPU

Бекенд - потребляет 600 МБ (+ 60) ОЗУ и по 1(+ 0.1) ядру на копию, у четом накладных расходов получается 660 ОЗУ + 1.1 CPU * 10 копий = 6600МБ и 11 CPU.

Итого, общее подтербление ресурсов на сервис:  
CPU = 3.3 + 3.3 + 1 + 11 = 18.6 CPU  
RAM = 13200 + 13200 + 275 + 6600 = 33576 МБ = 32,7 ГБ  

Если мы говорим про отказоустойчивость, то предполагается распределение сервса по нескольким нодам, возьмем 3, тогда на каждую ноду будет нагрузка:

CPU = 18.6/3 = 6,2
RAM = 32.7/3 = 10.9 Gb, округлим до 11.

Согласно [источнику](https://learnk8s.io/kubernetes-node-size) учтем расходы операционной системы, kubelet'a и запас в 100 МБ. Также добавим расходы на демонов zabbix'a, node exporter'a, обвесов безопасности в виде fail2ban, получается прибавляем к каждой ноде: **2Gb RAM, 1 CPU.**

В итоге для развертывания сервиса в трех средах на трех серверах понадобятся следующие мощности:

3 сервера с минимальными характеристиками 20 CPU и 35Gb RAM каждый.

Для этих целей можно взять CPU E5 2696 v3 на сокете LGA 2011-V3 (18 ядер, 36 потоков) + дешевой DDR3 оперативы, все это добро собрать на ssd-шном 10-м или 6-м программном рейде, главное не забыть подключить к IPS для graceful shutdown по необходимости.
